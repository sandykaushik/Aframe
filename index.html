<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Confined Space VR Training â€“ Working Baseline</title>

  <!-- A-Frame + Addons -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-super-hands-component@5.0.3/dist/aframe-super-hands.min.js"></script>

  <style>
    body { margin: 0; background: #000; }
  </style>

  <script>
    /* ===============================
       TRAINING MANAGER
    =============================== */
    AFRAME.registerComponent('training-manager', {
      init() {
        this.tasks = {
          atmosphereTested: false,
          hazardIdentified: false,
          isolated: false
        };

        this.el.sceneEl.addEventListener('meter-grabbed', () => {
          this.tasks.atmosphereTested = true;
          console.log('Task 1 complete: Atmosphere tested');
        });
      }
    });

    /* ===============================
       PROXIMITY HAZARD
    =============================== */
    AFRAME.registerComponent('proximity-hazard', {
      tick() {
        const rig = document.querySelector('#rig');
        const mgr = document.querySelector('[training-manager]').components['training-manager'];

        if (!mgr.tasks.atmosphereTested || mgr.tasks.hazardIdentified) return;

        const d = rig.object3D.position.distanceTo(this.el.object3D.position);
        if (d < 1.2) {
          mgr.tasks.hazardIdentified = true;
          console.log('Task 2 complete: Hazard identified');
        }
      }
    });

    /* ===============================
       ISOLATION VALVE
    =============================== */
    AFRAME.registerComponent('valve-logic', {
      init() {
        this.el.addEventListener('grab-end', () => {
          const mgr = document.querySelector('[training-manager]').components['training-manager'];
          if (!mgr.tasks.hazardIdentified) return;

          mgr.tasks.isolated = true;

          document.querySelector('#leakSound').components.sound.stopSound();
          document.querySelector('#ui').setAttribute('visible', true);

          console.log('Task 4 complete: Hazard isolated');
        });
      }
    });

    /* ===============================
       UI FACING CAMERA
    =============================== */
    AFRAME.registerComponent('look-at-camera', {
      tick() {
        this.el.object3D.lookAt(
          this.el.sceneEl.camera.el.object3D.position
        );
      }
    });
  </script>
</head>

<body>

<a-scene
  background="color: #111"
  fog="type: exponential; density: 0.02"
  renderer="physicallyCorrectLights: true">

  <!-- DEBUG SKY (REMOVE LATER) -->
  <a-sky color="#222"></a-sky>

  <!-- REQUIRED BASE LIGHT -->
  <a-light type="ambient" intensity="0.3"></a-light>

  <!-- PLAYER RIG -->
  <a-entity id="rig"
    position="0 1.6 2"
    movement-controls="speed: 0.03">

    <a-camera
      wasd-controls-enabled="false"
      look-controls
      super-hands>

      <!-- HEADLAMP -->
      <a-entity light="
        type: spot;
        intensity: 3;
        angle: 45;
        distance: 10">
      </a-entity>

    </a-camera>
  </a-entity>

  <!-- CONFINED TUNNEL -->
  <a-cylinder
    radius="1.2"
    height="12"
    position="0 1 -4"
    rotation="90 0 0"
    material="color: #444; side: double">
  </a-cylinder>

  <!-- GAS METER (TASK 1) -->
  <a-box id="gas-meter"
    position="-0.5 1.2 -2"
    depth="0.15"
    height="0.2"
    width="0.3"
    color="#555"
    grabbable
    event-set__grab="_event: grab-start; _emit: meter-grabbed">
  </a-box>

  <!-- LEAKING HOSE (TASK 2) -->
  <a-cylinder id="hose-hazard"
    position="0 0.9 -6"
    radius="0.05"
    height="1.2"
    color="#222"
    proximity-hazard>
  </a-cylinder>

  <a-sound id="leakSound"
    src="assets/hissing-leak-loop.mp3"
    autoplay="true"
    loop="true"
    position="0 0.9 -6">
  </a-sound>

  <!-- ISOLATION VALVE (TASK 4) -->
  <a-torus id="isolation-valve"
    position="0.6 0.9 -6"
    radius="0.15"
    radius-tubular="0.03"
    rotation="90 0 0"
    color="#aa0000"
    valve-logic>
  </a-torus>

  <!-- SUCCESS UI -->
  <a-entity id="ui"
    position="0 2 -1"
    visible="false"
    look-at-camera>
    <a-text
      value="Hazard Isolated Successfully"
      color="#00ff00"
      align="center">
    </a-text>
  </a-entity>

  <a-entity training-manager></a-entity>

</a-scene>

</body>
</html>
